#!/bin/bash

# ============================================================================
# LG TV Startup Script
# Turns on LG WebOS TV and switches to specified input on system boot
# ============================================================================

# UPDATE THESE: Change to match your setup
USERNAME="zany130"
ALGA_PATH="/home/${USERNAME}/.local/bin/alga"
TV_INPUT="HDMI_1"  # Change to your PC's input (e.g., HDMI_1, HDMI_2, HDMI_3, HDMI_4)

# Wait for local network to be connected (60 second timeout)
if ! nm-online -q -t 60; then
    echo "Network did not come online"
    exit 1
fi

# Validate that alga executable exists and is executable
if [[ ! -x "$ALGA_PATH" ]]; then
    echo "Error: alga executable not found or not executable at $ALGA_PATH"
    exit 1
fi

# Get the current power state of the TV
power_state=$("$ALGA_PATH" power screen-state 2>/dev/null | cut -d':' -f2 | xargs)

if [[ "$power_state" != "Active" ]]; then
    echo "Turning on TV and switching to $TV_INPUT"
    "$ALGA_PATH" power on
    sleep 7
    "$ALGA_PATH" input set "$TV_INPUT"
else
    echo "TV already on, checking input"
    current_input=$("$ALGA_PATH" input get 2>/dev/null | grep -o 'HDMI_[0-9]\+')
    if [[ "$current_input" != "$TV_INPUT" ]]; then
        echo "Switching to $TV_INPUT"
        "$ALGA_PATH" input set "$TV_INPUT"
    fi
fi
